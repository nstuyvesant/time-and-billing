@isTest
private class TimeAndBillingDailySpec {
  private static final DateTime SYNC_DATE = System.today().addDays(-1);
  private static final String SYNC_DATE_STRING = SYNC_DATE.format('yyyy-MM-dd', 'GMT');

  @isTest
  private static void testTimeAndBillingDaily() {
    SingleRequestMock TempoResponse1 = new SingleRequestMock(200, 'Complete',
      '{"self":"https://api.tempo.io/core/3/accounts","metadata":{"count":1},"results":[{"self":"https://api.tempo.io/core/3/accounts/0011U00000dhUVf","key":"0011U00000dhUVf","id":4,"name":"Marsh Risk Consulting","status":"OPEN","global":true,"monthlyBudget":0,"lead":{"self":"https://utilant.atlassian.net/rest/api/2/user?accountId=5cfa66cbd9f6b90f3d4b2f87","accountId":"5cfa66cbd9f6b90f3d4b2f87","displayName":"Kaleigh Carrow"},"category":{"self":"https://api.tempo.io/core/3/account-categories/HB","key":"HB","id":2,"name":"Hours Burndown","type":{"name":"Billable"}},"customer":{"self":"https://api.tempo.io/core/3/customers/0011U00000dhUVf","key":"0011U00000dhUVf","id":42,"name":"Marsh Risk Consulting"},"links":{"self":"https://api.tempo.io/core/3/accounts/0011U00000dhUVf/links"}}]}',
      null);

    SingleRequestMock TempoResponse2 = new SingleRequestMock(200, 'Complete',
      '{"self":"https://api.tempo.io/core/3/worklogs?updatedFrom=2020-12-21&offset=0&limit=50","metadata":{"count":1,"offset":0,"limit":50},"results":[{"self":"https://api.tempo.io/core/3/worklogs/36","tempoWorklogId":36,"jiraWorklogId":10047,"issue":{"self":"https://utilant.atlassian.net/rest/api/2/issue/PS-12","key":"PS-12","id":12368},"timeSpentSeconds":3600,"billableSeconds":3600,"startDate":"2020-10-22","startTime":"15:00:00","description":"Core Sprint Planning","createdAt":"2020-10-21T20:47:14Z","updatedAt":"2020-12-23T18:48:42Z","author":{"self":"https://utilant.atlassian.net/rest/api/2/user?accountId=5de53e0acdc2d20d0537f999","accountId":"5de53e0acdc2d20d0537f999","displayName":"Nate Stuyvesant"},"attributes":{"self":"https://api.tempo.io/core/3/worklogs/36/work-attribute-values","values":[{"key":"_Account_","value":"0011U000017gxUc"},{"key":"_Activity_","value":"Planning"}]}}]}',
      null);

    SingleRequestMock TempoResponse3 = new SingleRequestMock(200, 'Complete',
      '{"self":"https://api.tempo.io/audit/1/events/deleted/types/worklog?limit=1000&updatedFrom=2021-01-26T00:00:00Z","metadata":{"limit":1000,"count":8},"results":[{"deletedAt":"2021-01-26T17:04:10.419000","tempoWorklogId":"7373","jiraWorklogId":"17384"},{"deletedAt":"2021-01-26T17:07:03.110000","tempoWorklogId":"7271","jiraWorklogId":"17282"},{"deletedAt":"2021-01-26T17:10:12.238000","tempoWorklogId":"7382","jiraWorklogId":"17393"},{"deletedAt":"2021-01-26T20:07:19.381000","tempoWorklogId":"6735","jiraWorklogId":"16746"},{"deletedAt":"2021-01-26T20:07:50.444000","tempoWorklogId":"7243","jiraWorklogId":"17254"},{"deletedAt":"2021-01-27T15:42:38.797000","tempoWorklogId":"7739","jiraWorklogId":"17750"},{"deletedAt":"2021-02-01T13:19:20.193000","tempoWorklogId":"8995","jiraWorklogId":"19006"},{"deletedAt":"2021-02-01T15:00:47.981000","tempoWorklogId":"8997","jiraWorklogId":"19008"}]}',
      null);

    SingleRequestMock JiraResponse1 = new SingleRequestMock(200, 'Complete',
      '[{"self":"https://utilant.atlassian.net/rest/api/3/user?accountId=557058:0867a421-a9ee-4659-801a-bc0ee4a4487e","accountId":"557058:0867a421-a9ee-4659-801a-bc0ee4a4487e","accountType":"app","avatarUrls":{"48x48":"https://secure.gravatar.com/avatar/ab3787cd0c16633ae050dff9d5ab15fc?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FS-0.png","24x24":"https://secure.gravatar.com/avatar/ab3787cd0c16633ae050dff9d5ab15fc?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FS-0.png","16x16":"https://secure.gravatar.com/avatar/ab3787cd0c16633ae050dff9d5ab15fc?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FS-0.png","32x32":"https://secure.gravatar.com/avatar/ab3787cd0c16633ae050dff9d5ab15fc?d=https%3A%2F%2Favatar-management--avatars.us-west-2.prod.public.atl-paas.net%2Finitials%2FS-0.png"},"displayName":"Slack","active":true}]',
      null);

    SingleRequestMock JiraResponse2 = new SingleRequestMock(200, 'Complete',
      '{"expand":"schema,names","startAt":0,"maxResults":50,"total":1,"issues":[{"expand":"operations,versionedRepresentations,editmeta,changelog,customfield_10085.properties,customfield_10086.properties,renderedFields","id":"17426","self":"https://utilant.atlassian.net/rest/api/3/issue/17426","key":"VEN-150","fields":{"statuscategorychangedate":"2020-12-21T13:52:58.821-0500","customfield_10070":null,"customfield_10071":null,"customfield_10072":null,"customfield_10073":null,"customfield_10074":null,"customfield_10075":null,"customfield_10076":null,"customfield_10077":null,"fixVersions":[],"customfield_10078":null,"customfield_10079":null,"resolution":null,"lastViewed":null,"customfield_10060":null,"customfield_10063":null,"customfield_10064":null,"customfield_10065":null,"customfield_10066":null,"customfield_10100":null,"priority":{"self":"https://utilant.atlassian.net/rest/api/3/priority/3","iconUrl":"https://utilant.atlassian.net/images/icons/priorities/medium.svg","name":"Medium","id":"3"},"customfield_10067":null,"customfield_10101":{"self":"https://utilant.atlassian.net/rest/api/3/customFieldOption/10626","value":"Vendor","id":"10626"},"customfield_10068":null,"customfield_10069":null,"customfield_10102":null,"labels":[],"aggregatetimeoriginalestimate":null,"timeestimate":null,"versions":[],"issuelinks":[],"assignee":null,"status":{"self":"https://utilant.atlassian.net/rest/api/3/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://utilant.atlassian.net/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://utilant.atlassian.net/rest/api/3/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://utilant.atlassian.net/rest/api/3/component/10332","id":"10332","name":"RCT"}],"customfield_10050":null,"customfield_10051":null,"customfield_10052":null,"customfield_10053":null,"customfield_10054":null,"customfield_10055":null,"customfield_10056":null,"customfield_10057":null,"customfield_10058":null,"customfield_10059":null,"customfield_10049":null,"aggregatetimeestimate":null,"creator":{"self":"https://utilant.atlassian.net/rest/api/3/user?accountId=5d1b6eb6ca72d00d24b9f139","accountId":"5d1b6eb6ca72d00d24b9f139","emailAddress":"btyszka@utilant.com","avatarUrls":{"48x48":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/48","24x24":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/24","16x16":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/16","32x32":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/32"},"displayName":"Brian Tyszka","active":true,"timeZone":"America/New_York","accountType":"atlassian"},"subtasks":[],"customfield_10040":null,"customfield_10041":null,"customfield_10042":null,"reporter":{"self":"https://utilant.atlassian.net/rest/api/3/user?accountId=5d1b6eb6ca72d00d24b9f139","accountId":"5d1b6eb6ca72d00d24b9f139","emailAddress":"btyszka@utilant.com","avatarUrls":{"48x48":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/48","24x24":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/24","16x16":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/16","32x32":"https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/5d1b6eb6ca72d00d24b9f139/10e13664-fe9a-4e03-b3d9-a7d835e616d8/32"},"displayName":"Brian Tyszka","active":true,"timeZone":"America/New_York","accountType":"atlassian"},"customfield_10043":null,"aggregateprogress":{"progress":0,"total":0},"customfield_10044":null,"customfield_10045":null,"customfield_10046":null,"customfield_10047":null,"customfield_10048":null,"customfield_10038":null,"customfield_10039":null,"progress":{"progress":0,"total":0},"votes":{"self":"https://utilant.atlassian.net/rest/api/3/issue/VEN-150/votes","votes":0,"hasVoted":false},"issuetype":{"self":"https://utilant.atlassian.net/rest/api/3/issuetype/10001","id":"10001","description":"Functionality or a feature expressed as a user goal.","iconUrl":"https://utilant.atlassian.net/secure/viewavatar?size=medium&avatarId=10315&avatarType=issuetype","name":"Story","subtask":false,"avatarId":10315},"timespent":null,"customfield_10030":null,"customfield_10031":[],"project":{"self":"https://utilant.atlassian.net/rest/api/3/project/10000","id":"10000","key":"VEN","name":"Vendor","projectTypeKey":"software","simplified":false,"avatarUrls":{"48x48":"https://utilant.atlassian.net/secure/projectavatar?pid=10000&avatarId=10584","24x24":"https://utilant.atlassian.net/secure/projectavatar?size=small&s=small&pid=10000&avatarId=10584","16x16":"https://utilant.atlassian.net/secure/projectavatar?size=xsmall&s=xsmall&pid=10000&avatarId=10584","32x32":"https://utilant.atlassian.net/secure/projectavatar?size=medium&s=medium&pid=10000&avatarId=10584"}},"customfield_10032":null,"customfield_10033":null,"aggregatetimespent":null,"customfield_10034":null,"customfield_10035":null,"customfield_10036":null,"customfield_10037":null,"customfield_10028":"In Queue","resolutiondate":null,"workratio":-1,"watches":{"self":"https://utilant.atlassian.net/rest/api/3/issue/VEN-150/watchers","watchCount":1,"isWatching":false},"created":"2020-12-21T13:52:58.517-0500","customfield_10020":null,"customfield_10021":null,"customfield_10022":null,"customfield_10023":null,"customfield_10016":null,"customfield_10017":null,"customfield_10018":{"hasEpicLinkFieldDependency":false,"showField":false,"nonEditableReason":{"reason":"EPIC_LINK_SHOULD_BE_USED","message":"To set an epic as the parent, use the epic link instead"}},"customfield_10019":"0|i014oh:","updated":"2020-12-21T13:56:56.883-0500","customfield_10090":{"self":"https://utilant.atlassian.net/rest/api/3/customFieldOption/10775","value":"Hourly","id":"10775"},"customfield_10091":null,"customfield_10092":null,"customfield_10093":null,"customfield_10094":null,"timeoriginalestimate":null,"customfield_10096":null,"description":null,"customfield_10097":null,"customfield_10010":null,"customfield_10098":null,"customfield_10099":null,"customfield_10014":"VEN-149","customfield_10015":null,"customfield_10005":null,"customfield_10006":null,"customfield_10007":null,"security":null,"customfield_10008":null,"customfield_10009":null,"summary":"RCT - Get Assumptions","customfield_10080":null,"customfield_10081":null,"customfield_10082":null,"customfield_10083":null,"customfield_10085":null,"customfield_10086":{"id":73,"value":"Utilant, LLC"},"customfield_10088":null,"customfield_10000":"{}","customfield_10001":null,"customfield_10002":null,"customfield_10003":null,"customfield_10004":null,"environment":null,"duedate":null}}]}',
      null);

    SingleRequestMock ZenDeskResponse1 = new SingleRequestMock(200, 'Complete',
      '{"users":[{"id":370976246333,"url":"https://utilant.zendesk.com/api/v2/users/370976246333.json","name":"Nate Stuyvesant","email":"zendesk@utilant.com","created_at":"2018-12-21T18:15:50Z","updated_at":"2020-12-23T19:52:36Z","time_zone":"Eastern Time (US & Canada)","iana_time_zone":"America/New_York","phone":"+1-412-486-5555","shared_phone_number":false,"photo":null,"locale_id":1,"locale":"en-US","organization_id":360100722813,"role":"admin","verified":true,"external_id":null,"tags":[],"alias":"","active":true,"shared":false,"shared_agent":false,"last_login_at":"2020-12-23T19:52:36Z","two_factor_auth_enabled":null,"signature":"","details":"","notes":"","role_type":null,"custom_role_id":null,"moderator":true,"ticket_restriction":null,"only_private_comments":false,"restricted_agent":false,"suspended":false,"chat_only":false,"default_group_id":360007894353,"report_csv":true,"user_fields":{}}],"next_page":null,"previous_page":null,"count":7}',
      null);

    SingleRequestMock ZenDeskResponse2 = new SingleRequestMock(200, 'Complete',
      '{"results":[{"url":"https://utilant.zendesk.com/api/v2/organizations/370270598734.json","id":370270598734,"name":"SEER Insurance Inspections, Inc.","shared_tickets":false,"shared_comments":false,"external_id":null,"created_at":"2019-12-02T18:22:02Z","updated_at":"2020-04-20T13:21:48Z","domain_names":["seerinspections.com"],"details":"","notes":"","group_id":null,"tags":["vendor","incident"],"organization_fields":{"authorized_contacts":null,"database":"MSSQLPROD01","entitlement":"incident","outage_emails":"jlynes@seerinspections.com; jhlynes@seerinspections.com; mlynes@seerinspections.com","server":"FEE-WEB01","type":"vendor"},"result_type":"organization"}],"facets":null,"next_page":"https://utilant.zendesk.com/api/v2/search.json?page=2&query=type%3Aorganization","previous_page":null,"count":1}',
      null);

    SingleRequestMock ZenDeskResponse3 = new SingleRequestMock(200, 'Complete',
      '{"results":[{"url":"https://utilant.zendesk.com/api/v2/organizations/370270598354.json","id":370270598354,"name":"Reliable Reports","shared_tickets":false,"shared_comments":false,"external_id":null,"created_at":"2019-12-02T18:20:10Z","updated_at":"2019-12-04T13:33:21Z","domain_names":["reliablereports.com"],"details":"","notes":"","group_id":null,"tags":["prospect","vendor","incident"],"organization_fields":{"authorized_contacts":null,"database":null,"entitlement":"incident","outage_emails":null,"server":null,"type":"vendor"},"result_type":"organization"}],"facets":null,"next_page":null,"previous_page":"https://utilant.zendesk.com/api/v2/search.json?page=1&query=type%3Aorganization","count":1}',
      null);

    SingleRequestMock ZenDeskResponse4 = new SingleRequestMock(200, 'Complete',
      '{"results":[{"url":"https://utilant.zendesk.com/api/v2/tickets/4566.json","id":4566,"external_id":null,"via":{"channel":"voice","source":{"rel":"voicemail","from":{"formatted_phone":"+1 (951) 698-2909","phone":"+19516982909","name":"Gary Johnsson"},"to":{"formatted_phone":"+1 (619) 773-0300","phone":"+16197730300","name":"Utilant","brand_id":360001684393}}},"created_at":"2020-12-22T19:42:15Z","updated_at":"2020-12-22T21:32:34Z","type":"incident","subject":"Voicemail from: Gary Johnsson","raw_subject":"Voicemail from: Gary Johnsson","description":"Call from: +1 (951) 698-2909 Time of call: December 22, 2020 at 7:38:33 PM","priority":"normal","status":"solved","recipient":null,"requester_id":428181826253,"submitter_id":428181826253,"assignee_id":399513725134,"organization_id":370309460473,"group_id":360002709693,"collaborator_ids":[],"follower_ids":[],"email_cc_ids":[],"forum_topic_id":null,"problem_id":null,"has_incidents":false,"is_public":false,"due_at":null,"tags":["kbarticleno","question","rapid","rapidsketch","rapidsketch__3rd_party_integrated"],"custom_fields":[{"id":360046468354,"value":null},{"id":360036673293,"value":null},{"id":360030674453,"value":"rapidsketch__3rd_party_integrated"},{"id":360046467614,"value":null},{"id":360046459433,"value":null},{"id":360033650234,"value":null},{"id":360031860813,"value":"Voicemail kicked me out of leaving message. Waiting for callback."},{"id":360033610373,"value":null},{"id":360046467473,"value":null},{"id":360046478494,"value":null},{"id":360030708654,"value":"180"},{"id":360046476994,"value":null},{"id":360030708674,"value":"180"},{"id":360034768333,"value":null},{"id":360046467793,"value":null},{"id":360033846494,"value":null},{"id":360030553573,"value":null},{"id":360037988074,"value":"kbarticleno"},{"id":360046468334,"value":null},{"id":360030745593,"value":"question"}],"satisfaction_rating":{"score":"unoffered"},"sharing_agreement_ids":[],"fields":[{"id":360046468354,"value":null},{"id":360036673293,"value":null},{"id":360030674453,"value":"rapidsketch__3rd_party_integrated"},{"id":360046467614,"value":null},{"id":360046459433,"value":null},{"id":360033650234,"value":null},{"id":360031860813,"value":"Voicemail kicked me out of leaving message. Waiting for callback."},{"id":360033610373,"value":null},{"id":360046467473,"value":null},{"id":360046478494,"value":null},{"id":360030708654,"value":"180"},{"id":360046476994,"value":null},{"id":360030708674,"value":"180"},{"id":360034768333,"value":null},{"id":360046467793,"value":null},{"id":360033846494,"value":null},{"id":360030553573,"value":null},{"id":360037988074,"value":"kbarticleno"},{"id":360046468334,"value":null},{"id":360030745593,"value":"question"}],"followup_ids":[],"ticket_form_id":360004523793,"brand_id":360001684393,"satisfaction_probability":null,"allow_channelback":false,"allow_attachments":true,"result_type":"ticket"}],"facets":null,"next_page":null,"previous_page":null,"count":1}',
      null);

    Map<String, HttpCalloutMock> endpoint2TestResp = new Map<String,HttpCalloutMock>();
        
    endpoint2TestResp.put('callout:Tempo/core/3/accounts', TempoResponse1);
    endpoint2TestResp.put('callout:Tempo/core/3/worklogs?limit=1000&offset=0&updatedFrom=' + SYNC_DATE_STRING, TempoResponse2);
    endpoint2TestResp.put('callout:Tempo/audit/1/events/deleted/types/worklog?limit=1000&updatedFrom=' + SYNC_DATE_STRING + 'T00:00:00.000Z', TempoResponse3);
    endpoint2TestResp.put('callout:Jira/rest/api/3/users/search?maxResults=1000', JiraResponse1);
    endpoint2TestResp.put('callout:Jira/rest/api/3/search', JiraResponse2);
    endpoint2TestResp.put('callout:Zendesk/api/v2/users.json?role[]=admin&role[]=agent', ZenDeskResponse1);
    endpoint2TestResp.put('callout:Zendesk/api/v2/search.json?query=type:organization', ZenDeskResponse2);
    endpoint2TestResp.put('callout:Zendesk/api/v2/search.json?page=2&query=type%3Aorganization', ZenDeskResponse3);
    endpoint2TestResp.put('callout:Zendesk/api/v2/search.json?query=type%3Aticket+solved%3E%3D' + SYNC_DATE_STRING, ZenDeskResponse4);

    HttpCalloutMock multiCalloutMock = new MultiRequestMock(endpoint2TestResp);

    Test.setMock(HttpCalloutMock.class, multiCalloutMock);

    Test.startTest();
    String CRON_EXP = '0 0 0 3 9 ? 2022';
    String jobId = System.schedule('testBasicScheduledApex',
      CRON_EXP, 
      new TimeAndBillingDaily()
    );
    Test.stopTest();
  }
}
